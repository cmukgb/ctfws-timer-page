<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>CtFwS Timer</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
      .vertical-center {
        display: flex;
        align-items: center;
      }
      .grey-background {
        background-color: #f5f5f5;
      }
    </style>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Latest compiled and minified Bootstrap JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!-- Latest compiled and minified MQTT Paho JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <!-- MQTT code using Paho -->
    <script>
      function getNow() {
        var now = new Date();
        return Math.round(now.getTime() / 1000);
      }

      function toHMS(time) {
        var negative = false;
        if (time < 0) {
          negative = true;
          time = time * -1;
        }

        var hours = Math.floor(time / 3600);
        time = time - hours * 3600;
        var minutes = Math.floor(time / 60);
        var seconds = time - minutes * 60;

        var result = "";
        if (hours == 0) {
          result = minutes + ":" + (seconds < 10 ? "0" + seconds : seconds);
        } else {
          result =  hours + ":" + (minutes < 10 ? "0" + minutes : minutes) +
            ":" + (seconds < 10 ? "0" + seconds : seconds);
        }
        return (negative ? "-" : "") + result;
      }

      // Sets the two spans which form the game header text field
      function setGameHeader(firstText, secondText, secondClass) {
        $("#gameHeader1").text(firstText);
        $("#gameHeader2").text(secondText);
        $("#gameHeader2").removeClass();
        $("#gameHeader2").addClass(secondClass);
      }

      // Sets the color of a progress bar
      function setBarColor(barName, color) {
        $(barName).removeClass("progress-bar-success");
        $(barName).removeClass("progress-bar-info");
        $(barName).removeClass("progress-bar-warning");
        $(barName).removeClass("progress-bar-danger");
        $(barName).addClass(color);
      }

      // UI const variables
      var redFlagsText = "Red has captured: ";
      var yellowFlagsText = "Yellow has captured: ";
      var flagsText = "Total per side: ";

      // UI state variables
      //   Config
      var gameValid = false; // whether the most recent config msg was "none"
      var gameStarttime = 0;
      var setupDuration = 0;
      var numRounds = 0;
      var roundDuration = 0;
      var flagsPerTeam = 0;
      var gameNumber = 0;
      //   Flags
      var showFlags = true;
      var numRedFlags = 0;
      var numYellowFlags = 0;
      //   Endtime
      var gameEndtime = 0;
      //   Messages
      var gameMessages = [];

      // Function which updates the page based on the above variables
      function updateUI() {
        // Config and Endtime
        if (gameValid) {
          $("#flagsHeader").text(flagsText + flagsPerTeam);

          var now = getNow();
          var setupEnd = gameStarttime + setupDuration;
          var gameEnd = setupEnd + (numRounds * roundDuration); // scheduled end
          var gameDuration = gameEnd - setupEnd;
          var startDate = new Date(gameStarttime * 1000);
          var gameStartText = startDate.toLocaleTimeString();
          var numText = gameNumber == 0 ? "State" : gameNumber;

          if ((gameEndtime >= gameStarttime && gameEndtime <= now) ||
              gameEnd <= now) {
            // Over
            setGameHeader("Game " + numText + ": ", "Over", "text-danger");
            $("#startTimeLabel").text("Game started at " + gameStartText);
            var secs = 0;
            if (gameEndtime >= gameStarttime && gameEndtime <= now) {
              secs = Math.max(Math.min(gameEndtime, gameEnd) - setupEnd, 0);
            } else {
              secs = gameEnd - setupEnd;
            }
            var roundNum = Math.floor((secs - 1) / roundDuration); // 0-indexed
            var roundSecs = secs - roundNum * roundDuration;
            $("#setupJailbreakLabel").text("Jailbreak " + (roundNum + 1));
            var percent1 = Math.round((100 * roundSecs) / roundDuration);
            $("#firstBar").width(percent1 + "%");
            setBarColor("#firstBar", "progress-bar-danger");
            $("#firstBarLabel").text(toHMS(roundSecs) + " / " +
                toHMS(roundDuration));
            var percent2 = Math.round((100 * secs) / gameDuration);
            $("#secondBar").width(percent2 + "%");
            setBarColor("#secondBar", "progress-bar-danger");
            $("#secondBarLabel").text(toHMS(secs) + " / " +
                toHMS(gameDuration));
          } else if (setupEnd <= now) {
            // Playing
            setGameHeader("Game " + numText + ": ", "In Progress",
                "text-success");
            $("#startTimeLabel").text("Game started at " + gameStartText);
            var secs = now - setupEnd;
            var roundNum = Math.floor((secs - 1) / roundDuration); // 0-indexed
            var roundSecs = secs - roundNum * roundDuration;
            $("#setupJailbreakLabel").text("Jailbreak " + (roundNum + 1));
            var percent1 = Math.round((100 * roundSecs) / roundDuration);
            $("#firstBar").width(percent1 + "%");
            setBarColor("#firstBar", "progress-bar-warning");
            $("#firstBarLabel").text(toHMS(roundSecs) + " / " +
                toHMS(roundDuration));
            var percent2 = Math.round((100 * secs) / gameDuration);
            $("#secondBar").width(percent2 + "%");
            setBarColor("#secondBar", "progress-bar-success");
            $("#secondBarLabel").text(toHMS(secs) + " / " +
                toHMS(gameDuration));
          } else {
            // Setup
            setGameHeader("Game " + numText + ": ", "Setup", "text-info");
            $("#startTimeLabel").text("Game starts at " + gameStartText);
            $("#setupJailbreakLabel").text("Setup");
            var secs = now - gameStarttime;
            var percent = Math.round((100 * secs) / setupDuration);
            $("#firstBar").width(percent + "%");
            setBarColor("#firstBar", "progress-bar-info");
            $("#firstBarLabel").text(toHMS(secs) + " / " +
                toHMS(setupDuration));
            $("#secondBar").width("0%");
            setBarColor("#secondBar", "progress-bar-success");
            $("#secondBarLabel").text(toHMS(0) + " / " + toHMS(gameDuration));
          }

        } else {
          // None
          setGameHeader("No Current Game", "", "");
          $("#startTimeLabel").text("");
          $("#setupJailbreakLabel").text("Setup");
          $("#firstBar").width("0%");
          setBarColor("#firstBar", "progress-bar-danger");
          $("#firstBarLabel").text("0:00 / 15:00");
          $("#secondBar").width("0%");
          setBarColor("#secondBar", "progress-bar-danger");
          $("#secondBarLabel").text("0:00 / 1:00:00");
          $("#flagsHeader").text(flagsText + "0");
        }

        // Flags
        if (showFlags) {
          $("#redFlagsHeader").text(redFlagsText + numRedFlags);
          $("#yellowFlagsHeader").text(yellowFlagsText + numYellowFlags);
        } else {
          $("#redFlagsHeader").text(redFlagsText + "?");
          $("#yellowFlagsHeader").text(yellowFlagsText + "?");
        }

        // Messages
        var firstRow = '<tr><th class="col-sm-2 col-xs-2">Time<\/th>' +
          '<th>Message<\/th><\/tr>';
        $("#messageTable").html(firstRow);
        for (i = gameMessages.length - 1; i >= 0; i--) {
          var secs = gameMessages[i][0];
          var time = (new Date(secs * 1000)).toLocaleTimeString();
          var color = "";
          if (gameValid) {
            var now = getNow();
            var setupEnd = gameStarttime + setupDuration;
            var gameEnd = setupEnd + (numRounds * roundDuration); // scheduled end
            var cutoff = 0;
            if (gameEndtime >= gameStarttime && gameEndtime <= now) {
              cutoff = Math.min(gameEndtime, gameEnd);
            } else {
              cutoff = gameEnd;
            }
            if (secs < gameStarttime) {
              color = "active";
            } else if (secs < setupEnd) {
              color = "info";
            } else if (secs < cutoff) {
              color = "success";
            } else {
              color = "danger";
            }
          }
          var newRow = '<tr class="' + color + '"><td>' + time + '<\/td><td>' +
            gameMessages[i][1] + '<\/td><\/tr>';
          $("#messageTable").append(newRow);
        }
      }

      var hostname = "ws://kgb.club.cc.cmu.edu:1884/mqtt";
      var clientId = "cmukgb_webapp_" + Math.random().toString(16).substr(2, 8);

      // Create a client instance
      var client = new Paho.MQTT.Client(hostname, clientId);

      // set callback handlers
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      // connect the client
      client.connect({onSuccess:onConnect,onFailure:onConnectFail});

      function onConnectFail(failureObject) {
        console.log("onConnectFail: " + failureObject);
      }

      // called when the client connects
      function onConnect() {
        // Once a connection has been made, subscribe to all topics.
        console.log("onConnect");
        client.subscribe("ctfws/game/#");
        setInterval(updateUI, 500);
      }

      // called when the client loses its connection
      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("onConnectionLost: " + responseObject.errorMessage);
        }
      }

      // split a string into an array, splitting on whitespace
      // also checks that the resulting array has the expected length
      function splitOnWhitespace(str, expectedLen) {
        var a = str.split(/\s+/);
        if (a.length != expectedLen) {
          console.log("Message does not have the expected number of fields (" +
              expectedLen + "): " + str);
          throw "wrong number of fields";
        }
        return a;
      }

      function splitOnFirstWhitespace(str) {
        var newStr = str.replace(/\s+/, ' ');
        var index = newStr.indexOf(' ');
        if (index == -1) {
          console.log("Message cannot be split on whitespace: " + str);
          throw "cannot split message";
        }
        return [newStr.substring(0, index), newStr.substring(index + 1)];
      }

      function compare_messages(a, b) {
        return a[0] - b[0];
      }

      // called when a message arrives
      function onMessageArrived(message) {
        console.log("onMessageArrived: " + message.destinationName + ": " +
            message.payloadString);

        var msg = message.payloadString;
        var topic = message.destinationName.substring(11);
        switch (topic) {
          case 'config':
            if (msg == "none") {
              gameValid = false;
            } else {
              var split = splitOnWhitespace(msg, 6);
              var start = parseInt(split[0]);
              var setup = parseInt(split[1]);
              var rounds = parseInt(split[2]);
              var roundlen = parseInt(split[3]);
              var flags = parseInt(split[4]);
              var game = parseInt(split[5]);
              if (!isNaN(start) && !isNaN(setup) && !isNaN(rounds) &&
                  !isNaN(roundlen) && !isNaN(flags) && !isNaN(game)) {
                gameStarttime = start;
                setupDuration = setup;
                numRounds = rounds;
                roundDuration = roundlen;
                flagsPerTeam = flags;
                gameNumber = game;
                gameValid = true;
              } else {
                console.log("Unknown config message: " + msg);
              }
            }
            break;
          case 'flags':
            if (msg == "?") {
              showFlags = false;
            } else {
              var split = splitOnWhitespace(msg, 2);

              var r = parseInt(split[0]);
              var y = parseInt(split[1]);
              if (!isNaN(r) && !isNaN(y)) {
                numRedFlags = r;
                numYellowFlags = y;
                showFlags = true;
              } else {
                console.log("Unknown flag message: " + msg);
              }
            }
            break;
          case 'endtime':
            var secs = parseInt(msg);
            if (!isNaN(secs)) {
              gameEndtime = secs;
            } else {
              colsole.log("Unknown endtime message: " + msg);
            }
            break;
          case 'message':
          case 'message/player':
            var split = splitOnFirstWhitespace(msg);
            var secs = parseInt(split[0]);
            var body = split[1];
            if (!isNaN(secs)) {
              gameMessages.push([secs, body]);
              gameMessages = gameMessages.sort(compare_messages);
            } else {
              console.log("Unknown message message: " + msg);
            }
            break;
          case 'message/jail':
            console.log("Ignoring jail message: " + msg);
            break;
          default:
            console.log("Unknown topic: " + message.destinationName);
        }

        updateUI();
      }

      $(window).unload(function() {
        console.log("disconnecting on window close")
        client.disconnect();
      });

      console.log("Finished setup");
    </script>
  </head>

  <body>
    <header class="grey-background">
      <div class="container-fluid">
        <div class="row vertical-center">
          <div class="col-sm-offset-1 col-sm-10 col-xs-12">
            <h5>
              Check out the
              <a href="https://play.google.com/store/apps/details?id=com.acmetensortoys.ctfwstimer">
                Android app
              </a>
              and
              <a href="https://www.dropbox.com/s/2qjcuh5eocol0xh/CtFwS%20Cheatsheet.pdf?dl=1">
                CtFwS Cheatsheet
              </a>
            </h5>
          </div>
        </div>
      </div>
    </header>

    <div class="container-fluid">
      <div class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-10 col-xs-12">
          <div class="page-header">
            <div class="row vertical-center">

              <div class="col-md-1 col-sm-2 col-xs-3">
                <a href="http://www.cmukgb.org">
                  <img src="http://www.cmukgb.org/2013/wp-content/uploads/2013/08/shield-1.png"
                    class="img-responsive" alt="KGB Logo">
                </a>
              </div>
              <div class="col-md-11 col-sm-10 col-xs-9">
                <h1>CMU KGB's CtFwS Timer</h1>
              </div>

            </div>
          </div>
        </div>

      </div>
      <div class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-10 col-xs-12">
          <div class="page-header">
            <h2 class="text-center">
              <span id="gameHeader1">Game State</span>
              <span id="gameHeader2"></span>
            </h2>
          </div>
        </div>

      </div>
      <div class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-10 col-xs-12">
          <p id="startTimeLabel" class="lead text-center"></p>
        </div>

      </div>
      <div class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-2 col-xs-3">
          <p id="setupJailbreakLabel" class="lead text-center">Setup</p>
        </div>

        <div class="col-sm-6 col-xs-6">
          <div class="progress">
            <div id="firstBar" class="progress-bar" role="progressbar"
              style="width: 0%">
            </div>
          </div>
        </div>

        <div class="col-sm-2 col-xs-3">
          <p id="firstBarLabel" class="lead text-center">0:00 / 15:00</p>
        </div>

      </div>
      <div class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-2 col-xs-3">
          <p class="lead text-center">Game Time Elapsed</p>
        </div>

        <div class="col-sm-6 col-xs-6">
          <div class="progress">
            <div id="secondBar" class="progress-bar" role="progressbar"
              style="width: 0%">
            </div>
          </div>
        </div>

        <div class="col-sm-2 col-xs-3">
          <p id="secondBarLabel" class="lead text-center">0:00 / 1:00:00</p>
        </div>

      </div>
      <div class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-10 col-xs-12">
          <div class="page-header">
            <h2 class="text-center">Flags</h2>
          </div>
        </div>

      </div>
      <div class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-10 col-xs-12">
          <h3 id="flagsHeader" class="text-center">Total per side: 0</h3>
        </div>

      </div>
      <div id="flagsRow" class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-5 col-xs-6">
          <h3 id="redFlagsHeader" class="text-center text-danger">
            Red has captured: 0
          </h3>
        </div>

        <div class="col-sm-5 col-xs-6">
          <h3 id="yellowFlagsHeader" class="text-center text-warning">
            Yellow has captured: 0
          </h3>
        </div>

      </div>
      <div class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-10 col-xs-12">
          <div class="page-header">
            <h2 class="text-center">Messages</h2>
          </div>
        </div>

      </div>
      <div class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-10 col-xs-12">
          <p>
          Note: Messages sent before the last time the page was loaded may not
          appear.
          <br>
          Messages sent before game start are
          <span class="text-muted">grey</span>, during setup are
          <span class="text-info">blue</span>, during game play are
          <span class="text-success">green</span>, and after game end are
          <span class="text-danger">red</span>.
          </p>
        </div>

      </div>
      <div class="row vertical-center">

        <div class="col-sm-offset-1 col-sm-10 col-xs-12">
          <table id="messageTable" class="table">
            <tr><th>Time</th><th>Message</th></tr>
          </table>
        </div>

      </div>
    </div>

    <footer class="grey-background">
      <div class="container-fluid">
        <div class="row vertical-center">
          <div class="col-sm-offset-1 col-sm-10 col-xs-12">
            <h6 class="text-muted">
              Conceived of and created by
                <a href="http://www.ietfng.org/nwf/">nwf</a>.
              Wrangled into a web "app" by
                <a href="https://github.com/michaelfelixmurphy">Murphy</a>.
              CtFwS created and run by the
                <a href="http://www.cmukgb.org">CMU KGB</a>.
              Full rules and history
                <a href="http://www.cmukgb.org/activities/ctfws.php">here</a>.
              This page is maintained on
                <a href="https://github.com/cmukgb/ctfws-timer-page">GitHub</a>.
              Questions or concerns contact
                <a href="mailto:exec@cmukgb.org">exec@cmukgb.org</a>.
            </h6>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>

